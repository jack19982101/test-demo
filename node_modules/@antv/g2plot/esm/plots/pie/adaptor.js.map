{"version":3,"file":"adaptor.js","sourceRoot":"","sources":["../../../src/plots/pie/adaptor.ts"],"names":[],"mappings":"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","sourcesContent":["import { deepMix, every, filter, get, isFunction, isString, isNil } from '@antv/util';\nimport { Params } from '../../core/adaptor';\nimport { legend, tooltip, interaction, animation, theme, state, annotation } from '../../adaptor/common';\nimport { Data } from '../../types';\nimport { flow, LEVEL, log, template } from '../../utils';\nimport { interval } from '../../adaptor/geometries';\nimport { PieOptions } from './types';\nimport { getTotalValue } from './utils';\n\n/**\n * 字段\n * @param params\n */\nfunction geometry(params: Params<PieOptions>): Params<PieOptions> {\n  const { chart, options } = params;\n  const { data, angleField, colorField, color, pieStyle } = options;\n\n  // 处理不合法的数据\n  let processData = filter(data, (d) => typeof d[angleField] === 'number' || isNil(d[angleField]));\n\n  // 打印异常数据情况\n  log(LEVEL.WARN, processData.length === data.length, 'illegal data existed in chart data.');\n\n  const allZero = every(processData, (d) => d[angleField] === 0);\n  if (allZero) {\n    // 数据全 0 处理，调整 position 映射\n    const percentageField = '$$percentage$$';\n    processData = processData.map((d) => ({ ...d, [percentageField]: 1 / processData.length }));\n    chart.data(processData);\n\n    const p = deepMix({}, params, {\n      options: {\n        xField: '1',\n        yField: percentageField,\n        seriesField: colorField,\n        isStack: true,\n        interval: {\n          color,\n          style: pieStyle,\n        },\n      },\n    });\n\n    interval(p);\n\n    // all zero 额外处理\n    chart.geometries[0].tooltip(`${colorField}*${angleField}`);\n  } else {\n    chart.data(processData);\n\n    const p = deepMix({}, params, {\n      options: {\n        xField: '1',\n        yField: angleField,\n        seriesField: colorField,\n        isStack: true,\n        interval: {\n          color,\n          style: pieStyle,\n        },\n      },\n    });\n\n    interval(p);\n  }\n\n  return params;\n}\n\n/**\n * meta 配置\n * @param params\n */\nfunction meta(params: Params<PieOptions>): Params<PieOptions> {\n  const { chart, options } = params;\n  const { meta, colorField } = options;\n\n  // meta 直接是 scale 的信息\n  const scales = deepMix({}, meta);\n  chart.scale(scales, {\n    [colorField]: { type: 'cat' },\n  });\n\n  return params;\n}\n\n/**\n * coord 配置\n * @param params\n */\nfunction coordinate(params: Params<PieOptions>): Params<PieOptions> {\n  const { chart, options } = params;\n  const { radius, innerRadius } = options;\n\n  chart.coordinate({\n    type: 'theta',\n    cfg: {\n      radius,\n      innerRadius,\n    },\n  });\n\n  return params;\n}\n\n/**\n * label 配置\n * @param params\n */\nfunction label(params: Params<PieOptions>): Params<PieOptions> {\n  const { chart, options } = params;\n  const { label, colorField, angleField } = options;\n\n  const geometry = chart.geometries[0];\n  // label 为 false, 空 则不显示 label\n  if (!label) {\n    geometry.label(false);\n  } else {\n    const { callback, ...cfg } = label;\n    const labelCfg = cfg;\n\n    // ① 提供模板字符串的 label content 配置\n    if (labelCfg.content) {\n      const { content } = labelCfg;\n      labelCfg.content = (data: object, dataum: any, index: number) => {\n        const name = data[colorField];\n        const value = data[angleField];\n        // dymatic get scale, scale is ready this time\n        const angleScale = chart.getScaleByField(angleField);\n        const percent = angleScale?.scale(value);\n        return isFunction(content)\n          ? // append pecent (number) to data, users can get origin data from `dataum._origin`\n            content({ ...data, percent }, dataum, index)\n          : isString(content)\n          ? template(content as string, {\n              value,\n              name,\n              // percentage (string), default keep 2\n              percentage: percent ? `${(percent * 100).toFixed(2)}%` : null,\n            })\n          : content;\n      };\n    }\n\n    // ② 转换 label type 和 layout type\n    const LABEL_TYPE_MAP = {\n      inner: 'pie-inner',\n      outer: 'pie',\n      spider: 'pie',\n    };\n    const LABEL_LAYOUT_TYPE_MAP = {\n      inner: '',\n      outer: 'pie-outer',\n      spider: 'pie-spider',\n    };\n    const labelType = LABEL_TYPE_MAP[labelCfg.type] || 'pie';\n    const labelLayoutType = LABEL_LAYOUT_TYPE_MAP[labelCfg.type] || 'pie-outer';\n    labelCfg.type = labelType;\n    labelCfg.layout = deepMix({}, labelCfg.layout, { type: labelLayoutType });\n\n    geometry.label({\n      // fix: could not create scale, when field is undefined（attributes 中的 fields 定义都会被用来创建 scale）\n      fields: colorField ? [angleField, colorField] : [angleField],\n      callback,\n      cfg: labelCfg,\n    });\n  }\n  return params;\n}\n\n/**\n * statistic 中心文本配置\n * @param params\n */\nfunction statistic(params: Params<PieOptions>): Params<PieOptions> {\n  const { chart, options } = params;\n  const { innerRadius, statistic, angleField } = options;\n\n  const annotationOptions = [];\n\n  /** 中心文本 指标卡 */\n  if (innerRadius && statistic) {\n    const { title, content } = statistic;\n\n    [title, content].forEach((option, index) => {\n      if (option === false) {\n        return;\n      }\n      const { style, formatter, offsetX, offsetY, rotate } = option;\n\n      const lineHeight = get(option, 'style.fontSize', 20);\n      chart.annotation().text(\n        deepMix(\n          {},\n          {\n            style: {\n              textAlign: 'center',\n            },\n            offsetY: index === 0 ? (content === false ? 0 : -lineHeight) : title === false ? 0 : lineHeight,\n          },\n          {\n            position: ['50%', '50%'],\n            content: (filterData: Data) => {\n              return formatter\n                ? formatter(null, filterData)\n                : index === 0\n                ? '总计'\n                : getTotalValue(filterData, angleField);\n            },\n            style,\n            offsetX,\n            offsetY,\n            rotate,\n            // append-info\n            key: 'statistic',\n          }\n        )\n      );\n    });\n  }\n\n  return flow(annotation(annotationOptions))(params);\n}\n\n/**\n * 饼图适配器\n * @param chart\n * @param options\n */\nexport function adaptor(params: Params<PieOptions>) {\n  // flow 的方式处理所有的配置到 G2 API\n  return flow(\n    geometry,\n    meta,\n    theme,\n    coordinate,\n    legend,\n    tooltip,\n    label,\n    state,\n    annotation(),\n    /** 指标卡中心文本 放在下层 */\n    statistic,\n    interaction,\n    animation\n  )(params);\n}\n"]}